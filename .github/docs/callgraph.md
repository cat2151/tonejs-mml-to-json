# 関数呼び出しグラフ生成システム

このドキュメントでは、GitHub ActionsとCodeQLを使用してJavaScript/TypeScriptコードの関数呼び出しグラフを自動生成するシステムについて説明します。

## 概要

このシステムは以下の機能を提供します：

1. **自動解析**: 毎日午前5時（JST）にCodeQLを使ってコードを解析
2. **スマートトリガー**: 過去24時間にユーザーのコミットがある場合のみ実行
3. **可視化**: Cytoscape.jsを使ったインタラクティブなグラフ表示
4. **自動更新**: 生成されたグラフを自動的にリポジトリに保存

## システム構成

### ファイル構成

```
.github/
├── workflows/
│   └── callgraph.yml          # メインワークフロー
├── codeql-queries/
│   └── callgraph.ql           # CodeQLカスタムクエリ
├── scripts/
│   └── convert-to-html.cjs    # CSV→HTML変換スクリプト
└── docs/
    └── callgraph.md           # このドキュメント

generated-docs/
└── callgraph.html             # 生成されたグラフ（自動生成）
```

### 処理フロー

1. **コミットチェック**
   - 過去24時間のコミット履歴を確認
   - GitHub Actionsボット以外のコミットがある場合のみ続行

2. **CodeQL解析**
   - JavaScript/TypeScriptファイルを対象に解析実行
   - カスタムクエリで関数呼び出し関係を抽出

3. **データ変換**
   - CodeQLの結果（SARIF形式）からCSVデータを生成
   - 「呼び出し元 -> 呼び出し先」の形式でペアを抽出

4. **グラフ生成**
   - CSVデータをCytoscape.js用のJSONに変換
   - インタラクティブなHTMLファイルを生成

5. **結果保存**
   - 生成されたHTMLファイルをリポジトリにコミット・プッシュ

## CodeQLクエリの詳細

### `callgraph.ql`の機能

- **対象**: JavaScript/TypeScriptの関数呼び出し
- **抽出内容**: 関数名レベルでの呼び出し関係
- **除外項目**:
  - 匿名関数
  - 名前のない関数
- **含む項目**:
  - 直接的な関数呼び出し
  - メソッド呼び出し
  - 自己再帰呼び出し

### クエリの仕組み

```javascript
// 主要な検出ロジック
from DataFlow::CallNode call, Function caller, Function callee
where
  caller = call.getEnclosingFunction() and
  callee = call.getACallee() and
  exists(caller.getName()) and
  exists(callee.getName())
```

## 生成されるHTMLの機能

### インタラクティブ機能

- **ドラッグ**: ノード（関数）の位置調整
- **ズーム**: マウスホイールでのズームイン/アウト
- **ハイライト**: ノードクリックで関連する呼び出し関係を強調
- **レイアウト**: 自動的な美しいグラフレイアウト

### 操作ボタン

- **Fit to Screen**: グラフ全体を画面に収める
- **Reset Layout**: レイアウトを初期状態に戻す
- **Toggle Labels**: 関数名の表示/非表示切り替え

### 統計情報

- 総関数数
- 総呼び出し関係数
- 生成日時

## 設定のカスタマイズ

### 実行タイミングの変更

`.github/workflows/callgraph.yml`の`cron`設定を変更：

```yaml
schedule:
  - cron: '0 20 * * *'  # 毎日JST 5:00 (UTC 20:00前日)
```

### 解析対象の変更

CodeQLクエリ（`callgraph.ql`）を編集して：

- 特定のファイルやディレクトリを除外
- 追加の関数呼び出しパターンを含める
- フィルタリング条件を調整

### グラフ表示のカスタマイズ

`convert-to-html.cjs`のスタイル設定を変更：

- ノードの色やサイズ
- エッジの太さや色
- レイアウトアルゴリズム
- UI要素の表示/非表示

## トラブルシューティング

### よくある問題

1. **CodeQL解析が失敗する**
   - JavaScript/TypeScriptファイルが正しく認識されているか確認
   - カスタムクエリの構文エラーをチェック

2. **グラフが空になる**
   - 対象コードに名前付き関数が存在するか確認
   - CodeQLクエリの条件が厳しすぎないかチェック

3. **HTMLが生成されない**
   - CSVファイルの形式が正しいか確認
   - Node.jsスクリプトのエラーログを確認

### デバッグ方法

1. **GitHub Actionsログの確認**
   - ワークフローの各ステップの実行結果を確認
   - エラーメッセージから問題の特定

2. **ローカルテスト**
   - `convert-to-html.cjs`を手動実行してテスト
   - サンプルCSVファイルでの動作確認

3. **CodeQLクエリテスト**
   - VS CodeのCodeQL拡張機能でクエリをテスト
   - 小さなサンプルコードでの動作確認

## セキュリティ考慮事項

- **権限**: ワークフローには最小限の権限のみ付与
- **依存関係**: 外部パッケージはCDNから読み込み（ローカルインストールなし）
- **データ**: 関数名のみを抽出（ソースコードの内容は含まない）

## 今後の拡張可能性

- **言語サポート**: Python、Java等への対応
- **メトリクス**: 複雑度分析、依存関係の深さ測定
- **通知**: Slack/Teams等への結果通知
- **比較**: 前回との差分表示機能
- **エクスポート**: PNG、SVG等の画像形式での出力

---

このシステムにより、プロジェクトのコード構造を視覚的に把握し、リファクタリングや新機能開発の際の影響範囲を理解しやすくなります。
