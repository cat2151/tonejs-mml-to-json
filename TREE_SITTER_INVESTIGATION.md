# Tree-sitter Integration Investigation Report

## Objective
Integrate Tree-sitter parser for MML (Music Macro Language) into the Rust library crate with WASM compatibility for browser TypeScript applications.

## Requirements
1. Use Tree-sitter (mandatory - no custom parsers allowed)
2. Rust library crate usable from native Rust applications
3. WASM compilation for browser TypeScript applications
4. Target: Linux

## Investigation Summary

### Option 1: rust-sitter (Pure Rust)
**Pros:**
- No C FFI dependency
- Native WASM support (wasm32-unknown-unknown)
- Idiomatic Rust with macros

**Cons:**
- Limited type support (encountered issues with `String`, `u32` in Option fields)
- Complex grammar constraints
- Less mature than official tree-sitter
- "InternSymbols Undefined" errors

**Verdict:** ❌ Not suitable for complex MML grammar

### Option 2: Official tree-sitter + grammar.js
**Pros:**
- Mature and well-documented
- Flexible grammar system
- Supports complex grammars

**Cons:**
- C ABI compatibility issues with wasm32-unknown-unknown
- Requires separate grammar compilation
- Need Emscripten or special sysroot for WASM
- Complex WASM integration

**Challenges identified:**
- Tree-sitter C library has wasm32-unknown-unknown ABI issues
- Requires special sysroot or translated parsers (like Arborium)
- May need wasmtime engine which adds overhead

**Verdict:** ⚠️ Technically possible but very complex

### Option 3: tree-sitter with WASM Grammar Loading
**Pros:**
- Official tree-sitter support
- Can load pre-compiled WASM grammars

**Cons:**
- Requires wasmtime engine
- Adds significant runtime overhead
- Complex setup

**Verdict:** ⚠️ Adds too much complexity

## Recommended Approaches (in order of preference)

### Approach A: Create grammar.js + Dual Implementation
1. Create official Tree-sitter grammar in `grammar.js`
2. Use tree-sitter for native Rust library (with C FFI)
3. For WASM:
   - Compile grammar to WASM separately
   - Use web-tree-sitter bindings directly from TypeScript
   - Or use tree-sitter with special WASM features

**Pros:**
- Fulfills Tree-sitter requirement
- Clean separation of concerns
- Leverages each platform's strengths

**Implementation:**
```
tree-sitter-mml/
├── grammar.js          # Tree-sitter grammar definition
├── src/
│   └── parser.c        # Generated by tree-sitter
├── bindings/
│   └── rust/           # Native Rust bindings
└── wasm/               # WASM compilation output
```

### Approach B: Two-Stage Build
1. Write grammar.js
2. Generate C parser
3. Build native Rust with tree-sitter C bindings
4. Build WASM using tree-sitter-c2rust or similar

### Approach C: Simplified rust-sitter Grammar
1. Simplify MML grammar to work within rust-sitter constraints
2. Use only supported types
3. Post-process AST to get desired structure

**Challenge:** MML grammar complexity may not fit rust-sitter limitations

## Proposed Solution

Given the complexity, I recommend **Approach A** with the following implementation plan:

1. **Create Tree-sitter Grammar**
   - Write `grammar.js` for MML
   - Test and validate grammar

2. **Native Rust Library**
   - Use official tree-sitter Rust bindings
   - Link against generated C parser
   - Provide native library crate

3. **WASM Support**
   - Compile grammar to WASM using tree-sitter CLI
   - Expose TypeScript bindings using web-tree-sitter
   - Document WASM usage separately

4. **Integration Layer**
   - Keep existing AST structures
   - Add converter from tree-sitter CST to existing AST
   - Maintain backward compatibility

## Next Steps

1. Create `grammar.js` for MML syntax
2. Set up tree-sitter grammar project structure
3. Generate and test parser
4. Integrate with Rust library for native use
5. Document WASM compilation and usage
6. Update build scripts

## References

- [Tree-sitter Documentation](https://tree-sitter.github.io/tree-sitter/)
- [rust-sitter GitHub](https://github.com/hydro-project/rust-sitter)
- [web-tree-sitter](https://github.com/tree-sitter/tree-sitter/tree/master/lib/binding_web)
- [Arborium WASM Example](https://notes.billmill.org/programming/rust/Arborium_-_tree-sitter_syntax_highlighting_for_rust_and_js.html)
- [Tree-sitter WASM Compilation](https://acorntalks.com/blog/dockerfile-wasm-tree-sitter/)
