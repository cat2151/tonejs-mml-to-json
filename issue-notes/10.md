# issue GitHub Actionsを使ってコールグラフを生成させるよう、agent向けプロンプトを書く #10
[issues #10](https://github.com/cat2151/tonejs-mml-to-json/issues/10)

# これまでの課題
- Geminiに、関数の呼び出し階層リストを生成させたところ、
    - 低品質であった
- これでは来訪者の体験がいまいち
- 開発者側としても、もっと高品質なものがあれば、開発時の認知負荷が下がるかもしれない

# 対策案
- GitHub Actions + CodeQL + Cytoscape.js を利用し、コールグラフを生成させる
    - これはChatGPTにきいて決めたもの
        - 関数呼び出し階層をGitHub Actionsで生成させるときの選択肢をlistさせ、メリット・デメリットを確認し、決めたもの
- prompt（ChatGPTが生成したpromptを、userが手直ししたもの）
    - 手直ししたのは：
        - 成果物の配置場所の考慮
        - package.json汚染防止
        - 過去24時間以内にcommit pushがあったときのみ生成
        - ESMとCommonJSどちらのprojectでも動くよう考慮
        - 説明書の生成
```
あなたはGitHub Actionsの設定が得意なエンジニアです。
以下の要件をすべて満たすGitHub Actionsワークフローと、必要な追加ファイルを作成してください。

# 要件
1. リポジトリはパブリックです。
2. 毎日午前5時(JST)にGitHub Actionsが実行されます。ただし過去24時間以内にuserからのcommitがあったときのみ実行とします。過去24時間以内のcommitがAIからのcommitだけだった場合は実行しません。
3. CodeQLの公式アクションを使い、JavaScript/TypeScriptコードの関数呼び出しグラフ(CallGraphモジュール)を解析してください。
4. 呼び出し元と呼び出し先のペアをすべて取得するカスタムQLファイル(callgraph.ql)を作成してください。
   - 各出力は「呼び出し元関数名 -> 呼び出し先関数名」の形式でCSVにまとめます。
5. 取得したCSVをCytoscape.jsを使ってインタラクティブなHTMLグラフに変換してください。
   - npmの依存パッケージも自動インストールしてください。
   - ただしGitHub Actions用のセオリーに則り、rootのpackage.jsonを汚染しない作りにしてください。
   - 生成されたHTMLは `generated-docs/callgraph.html` に保存します。
6. ワークフローの最後に、生成された `generated-docs/callgraph.html` をコミット＆pushしてください。
7. projectがESMでもCommonJSでも動くよう、拡張子はcjsを明示してください。

# 出力
- .github/workflows/callgraph.yml（GitHub Actionsワークフロー）
- .github/codeql-queries/callgraph.ql（カスタムQLファイル）
- .github/scripts/convert-to-html.cjs（CSV→Cytoscape.js HTML生成スクリプト）
- .github/docs/callgraph.md（関数呼び出しグラフ生成の説明）
- すぐに動く状態で作成してください。
- project root にある package.json は絶対に変更しないでください。

# 注意
- CodeQLの公式Actions（github/codeql-action/init, analyze）を必ず使用してください。
- 構文ミスの有無を繰り返してセルフチェックしてください。
```

# 想定
- エラーや想定外の動作があり、都度修正していく
- 最悪、失敗GitHub Actionsとして破棄する選択肢も考慮に入れる

# GitHub Actionsの生成はできた

# testする

# 結果
- コールグラフの生成はできた
- 課題、関数0件、関数の関係も0件
- 対策、agentに投げる
- 結果、低品質の気配がしてきたが、修正版ソースは生成された
- testする
