# issue 「;」コマンドによる複数track演奏を実装するにあたり、その準備に必要なものを可視化する #37
[issues #37](https://github.com/cat2151/tonejs-mml-to-json/issues/37)

## 調査結果

詳細な調査報告書を作成しました: [MULTI_TRACK_INVESTIGATION.md](../MULTI_TRACK_INVESTIGATION.md)

### 要約

#### Q1: TreeSitterでの「;」のパースや、各種変換処理で、上記のJSONは生成できるようになるか？

**回答**: **はい、可能です。**

現在のRustパーサーで「;」を認識するように拡張し、AST→JSON変換で複数trackを処理することで、tonejs-json-sequencer互換のJSONを生成できます。

**必要な変更**:
1. ASTにTrackSeparatorトークンを追加
2. 「;」文字のパース処理を追加
3. ast2jsonで複数trackを処理
4. イベントを時系列で統合

#### Q2: 演奏についても、上記 tonejs-json-sequencer をライブラリとして利用できるか？

**回答**: **利用可能ですが、必須ではありません。**

**選択肢**:
1. **現在のアプローチを維持**: 内部playerを使用
   - 既にJSON形式と互換性あり
   - 複数楽器のサポート検証が必要
   - プロジェクト間の独立性を維持
   
2. **ライブラリとして使用**: tonejs-json-sequencerをインポート
   - npm依存関係を追加
   - src/play.tsをライブラリ呼び出しに置き換え
   - より多くの機能（エフェクトなど）

**推奨**: 現在のアーキテクチャを維持し、playerが複数nodeIdを処理できることを確認

#### Q3: 既存のcodeの変更が必要か？

**回答**: **最小限の変更が必要です。**

**必要な変更**:
- ✅ **Rustパーサー**: セミコロン処理を追加（約20行）
- ✅ **Rust ast2json**: 複数track処理を追加（約100行）
- ✅ **TypeScript型**: TrackSeparator型を追加（約5行）
- ⚠️ **Player検証**: 複数楽器のサポートが動作することを確認
- ✅ **テスト**: 複数trackのテストケースを追加

**破壊的変更なし**: 単一trackのMMLは引き続き動作します

### 実装の優先順位

1. **Phase 1**: Rustパーサーの拡張（TrackSeparatorトークン追加）
2. **Phase 2**: ast2jsonの複数track処理実装
3. **Phase 3**: TypeScript型定義の更新
4. **Phase 4**: Player検証
5. **Phase 5**: ドキュメント更新

### 期待される動作例

**入力MML**:
```
o4 l8 cdef; o5 l8 egab
```

**期待されるJSON**（簡略版）:
- track 0用のcreatNode（nodeId=0）
- track 1用のcreateNode（nodeId=1）
- 両trackのイベントを時系列でソート
- 各trackは独立したoctave、length状態を持つ

### 見積もり工数

- パーサー変更: 2-3時間
- 変換ロジック: 4-6時間
- テスト: 3-4時間
- ドキュメント: 2-3時間
- **合計**: 約12-16時間

### 推奨事項

**実装を進めることを推奨します**:
- TrackSeparatorトークンをASTに追加
- ast2jsonで複数track処理を実装
- 現在のplayerアーキテクチャを維持
- tonejs-json-sequencerの統合は将来の拡張として検討

