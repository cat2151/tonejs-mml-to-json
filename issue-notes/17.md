# issue GitHub Actions「issue note生成」を共通ワークフロー化する #17
[issues #17](https://github.com/cat2151/tonejs-mml-to-json/issues/17)

# prompt
```
あなたはGitHub Actionsと共通ワークフローのスペシャリストです。
このymlを元に共通ワークフローを、別途作成済みで、
あとはそれを呼び出したいです。
このymlファイル名のまま、
中身を「共通ワークフローを呼び出すyml」にしてください。
まずplanしてください
```

# plan agent生成結果
プラン：

共通ワークフロー（Reusable Workflow）が既に作成済みとのことなので、現状の issue-note.yml を「共通ワークフローを呼び出すだけのYAML」に書き換えます。
呼び出し元YAMLでは workflow_call ではなく、uses: を使って共通ワークフローを参照します。
必要に応じて with: で入力パラメータや secrets: を渡します（共通ワークフローの定義に依存）。
トリガー（on:）やファイル名はそのまま維持します。
具体的な共通ワークフローのパスやリポジトリ名、必要な入力値は、既存の共通ワークフローの仕様に合わせて記述します。
次のステップ：

共通ワークフローのパスや必要な入力値が分かっている前提で、issue-note.yml を呼び出し用YAMLに書き換えます。
準備ができたら、ファイルを書き換えます。

# 書き換えさせた
# agentがコメントアウト（余計なお世話）した部分を、アンコメントさせた
# レビューさせた

# 共通ワークフロー部分を貼り付けて、整合性チェックさせた
## prompt
```
共通ワークフローを呼び出すときエラーにならないか、レビューしてください。

共通ワークフローは以下です：

name: Issue Note Generator

on:
  workflow_call:
    inputs:
      issue_title:
        required: true
        type: string
      issue_number:
        required: true
        type: string
      issue_body:
        required: true
        type: string
      issue_html_url:
        required: true
        type: string

jobs:
  create-issue-note:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate issue note markdown
        id: generate_md
        run: |
          mkdir -p issue-notes
          echo "# issue ${{ inputs.issue_title }} #${{ inputs.issue_number }}" > issue-notes/${{ inputs.issue_number }}.md
          echo "[issues #${{ inputs.issue_number }}](${{ inputs.issue_html_url }})" >> issue-notes/${{ inputs.issue_number }}.md
          echo "" >> issue-notes/${{ inputs.issue_number }}.md
          echo "${{ inputs.issue_body }}" >> issue-notes/${{ inputs.issue_number }}.md
      - name: Commit and push note
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add issue-notes/${{ inputs.issue_number }}.md
          git commit -m "Add issue note for #${{ inputs.issue_number }}"
          git push

      - name: Add link to issue note in issue body
        uses: actions/github-script@v7
        with:
          script: |
            const notePath = `issue-notes/${{ inputs.issue_number }}.md`;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const noteUrl = `https://github.com/${owner}/${repo}/blob/main/${notePath}`;
            const newBody = `[issue-notes/${{ inputs.issue_number }}.md](${noteUrl})\n\n${{ inputs.issue_body }}`;
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: Number(inputs.issue_number),
              body: newBody
            });
```

# 整合性エラーがあったので、agentに修正させた
# さらにレビューさせた
# 再度、共通ワークフロー側のymlを確認してほしいという依頼がきたので、上記のymlを再度貼り付けて、整合性チェックさせた
# 整合性チェック結果、OKとなった
# testする

# と思ったが、tokenのlinterエラーが真っ赤で、見ると実際バグっている
# 再度agentにチェックさせる
## prompt
```
linterのエラーが出ており、実際、共通ワークフロー側では使われていないようです。整合性チェックしてください。

共通ワークフローは以下です：

name: Issue Note Generator

on:
  workflow_call:
    inputs:
      issue_title:
        required: true
        type: string
      issue_number:
        required: true
        type: string
      issue_body:
        required: true
        type: string
      issue_html_url:
        required: true
        type: string

jobs:
  create-issue-note:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate issue note markdown
        id: generate_md
        run: |
          mkdir -p issue-notes
          echo "# issue ${{ inputs.issue_title }} #${{ inputs.issue_number }}" > issue-notes/${{ inputs.issue_number }}.md
          echo "[issues #${{ inputs.issue_number }}](${{ inputs.issue_html_url }})" >> issue-notes/${{ inputs.issue_number }}.md
          echo "" >> issue-notes/${{ inputs.issue_number }}.md
          echo "${{ inputs.issue_body }}" >> issue-notes/${{ inputs.issue_number }}.md
      - name: Commit and push note
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add issue-notes/${{ inputs.issue_number }}.md
          git commit -m "Add issue note for #${{ inputs.issue_number }}"
          git push

      - name: Add link to issue note in issue body
        uses: actions/github-script@v7
        with:
          script: |
            const notePath = `issue-notes/${{ inputs.issue_number }}.md`;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const noteUrl = `https://github.com/${owner}/${repo}/blob/main/${notePath}`;
            const newBody = `[issue-notes/${{ inputs.issue_number }}.md](${noteUrl})\n\n${{ inputs.issue_body }}`;
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: Number(inputs.issue_number),
              body: newBody
            });
```

# 結果、linterエラーが解消された

# test結果、エラー
## prompt
```
エラーになりました。原因を分析してください

1s
Run git config user.name github-actions
[main ecc2a89] Add issue note for #19
 1 file changed, 4 insertions(+)
 create mode 100644 issue-notes/19.md
To https://github.com/cat2151/tonejs-mml-to-json
   85411c5..ecc2a89  main -> main
0s
Run actions/github-script@v7
ReferenceError: inputs is not defined
    at eval (eval at callAsyncFunction (/home/runner/work/_actions/actions/github-script/v7/dist/index.js:35424:16), <anonymous>:11:24)
    at callAsyncFunction (/home/runner/work/_actions/actions/github-script/v7/dist/index.js:35425:12)
    at main (/home/runner/work/_actions/actions/github-script/v7/dist/index.js:35522:26)
    at /home/runner/work/_actions/actions/github-script/v7/dist/index.js:35497:1
    at /home/runner/work/_actions/actions/github-script/v7/dist/index.js:35553:3
    at Object.<anonymous> (/home/runner/work/_actions/actions/github-script/v7/dist/index.js:35556:12)
    at Module._compile (node:internal/modules/cjs/loader:1529:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1613:10)
    at Module.load (node:internal/modules/cjs/loader:1275:32)
    at Module._load (node:internal/modules/cjs/loader:1096:12)
Error: Unhandled error: ReferenceError: inputs is not defined
```

# prompt
```
共通ワークフローは以下です。前述のエラーと、呼び出し元yml、以上3つの情報から、原因を分析してください

name: Issue Note Generator

on:
  workflow_call:
    inputs:
      issue_title:
        required: true
        type: string
      issue_number:
        required: true
        type: string
      issue_body:
        required: true
        type: string
      issue_html_url:
        required: true
        type: string

jobs:
  create-issue-note:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate issue note markdown
        id: generate_md
        run: |
          mkdir -p issue-notes
          echo "# issue ${{ inputs.issue_title }} #${{ inputs.issue_number }}" > issue-notes/${{ inputs.issue_number }}.md
          echo "[issues #${{ inputs.issue_number }}](${{ inputs.issue_html_url }})" >> issue-notes/${{ inputs.issue_number }}.md
          echo "" >> issue-notes/${{ inputs.issue_number }}.md
          echo "${{ inputs.issue_body }}" >> issue-notes/${{ inputs.issue_number }}.md
      - name: Commit and push note
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add issue-notes/${{ inputs.issue_number }}.md
          git commit -m "Add issue note for #${{ inputs.issue_number }}"
          git push

      - name: Add link to issue note in issue body
        uses: actions/github-script@v7
        with:
          script: |
            const notePath = `issue-notes/${{ inputs.issue_number }}.md`;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const noteUrl = `https://github.com/${owner}/${repo}/blob/main/${notePath}`;
            const newBody = `[issue-notes/${{ inputs.issue_number }}.md](${noteUrl})\n\n${{ inputs.issue_body }}`;
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: Number(inputs.issue_number),
              body: newBody
            });
```

# agentに、共通ワークフロー側を修正させた
# test green

# まとめ
- ハルシネーションが多い
- 都度、userが軌道修正をしてやることで、ハルシネーションを訂正できている
- このレベルの認知負荷なら、休日寝る前のコンディションである現状でもなんとかなる。
  - ただし「共通ワークフローの知識を、ある程度持っているから」である。
- 贅沢を言うなら、このレベルのeasyなtaskなら、ハルシネーションなしで一発で自走しきってほしい
  - 特に、agentによるセルフレビューを通っているがそれはハルシネーションで、エラーが出てようやく軌道修正できた、というあたりに、自走力の低さを感じる

# closeとする
